<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Subway Surfers Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Fredoka+One&display=swap');
        
        body {
            overflow: hidden;
            background: #1a1a2e;
            font-family: 'Poppins', sans-serif;
            touch-action: none;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .ui-element {
            pointer-events: auto;
        }

        /* HUD - Mobile Optimized */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        #pause-btn {
            width: 45px;
            height: 45px;
            background: rgba(0, 100, 200, 0.9);
            border: 3px solid #fff;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        #pause-btn:active {
            transform: scale(0.95);
        }

        #score-container {
            text-align: right;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        #multiplier {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 1px;
            display: inline-block;
            margin-bottom: 3px;
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.5);
        }

        #score {
            font-size: 28px;
            color: white;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
            font-weight: 800;
        }

        #coins-display {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            margin-top: 3px;
        }

        .coin-icon {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            border: 2px solid #b8860b;
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.3);
        }

        #coins {
            font-size: 20px;
            color: #ffd700;
            text-shadow: 1px 1px 0 #000;
            font-weight: 800;
        }

        /* Main Menu - Mobile Optimized */
        #main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #87ceeb 0%, #e0f4ff 100%);
            z-index: 200;
            padding: 20px;
        }

        #game-logo {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            color: #ff6b35;
            text-shadow: 3px 3px 0 #2c3e50, 6px 6px 0 rgba(0,0,0,0.2);
            letter-spacing: 2px;
            margin-bottom: 15px;
            animation: logoFloat 2s ease-in-out infinite;
            text-align: center;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        #subtitle {
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        #high-score-display {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #27ae60;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        .menu-button {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.5rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 0 #1e8449, 0 15px 30px rgba(0,0,0,0.3);
            transition: all 0.1s;
            animation: pulse 1.5s ease-in-out infinite;
            width: 80%;
            max-width: 300px;
            margin: 10px 0;
        }

        .menu-button:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #1e8449, 0 10px 20px rgba(0,0,0,0.3);
        }

        #store-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            box-shadow: 0 8px 0 #6c3483;
        }

        #store-btn:active {
            box-shadow: 0 2px 0 #6c3483;
        }

        #controls-hint {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
            line-height: 1.6;
            padding: 0 20px;
        }

        #controls-hint span {
            display: inline-block;
            background: #ecf0f1;
            padding: 4px 10px;
            border-radius: 8px;
            margin: 0 3px;
            box-shadow: 0 3px 0 #bdc3c7;
        }

        /* Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 50;
        }

        .control-btn {
            width: 70px;
            height: 70px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            backdrop-filter: blur(5px);
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }

        .control-btn:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.8);
        }

        .control-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #up-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        #down-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        #left-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        #right-btn {
            background: linear-gradient(135deg, #f39c12, #d35400);
        }

        /* Swipe Area for mobile */
        #swipe-area {
            position: absolute;
            top: 100px;
            left: 0;
            width: 100%;
            height: calc(100% - 200px);
            pointer-events: auto;
            z-index: 10;
        }

        /* Game Over Screen */
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            padding: 20px;
        }

        #game-over-panel {
            background: white;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #game-over-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: #e74c3c;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px solid #ecf0f1;
        }

        .stat-label {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: #2c3e50;
        }

        #new-record {
            display: none;
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            margin: 15px 0;
            animation: recordPulse 0.5s ease-out infinite alternate;
        }

        @keyframes recordPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        #game-over-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }

        .game-over-btn {
            padding: 15px 25px;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.1s;
            flex: 1;
        }

        .game-over-btn:active {
            transform: scale(0.95);
        }

        #retry-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 5px 0 #1e8449;
        }

        #menu-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 5px 0 #1f618d;
        }

        /* Pause Screen */
        #pause-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 200;
        }

        #pause-panel {
            background: white;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            width: 80%;
            max-width: 300px;
        }

        #pause-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: #3498db;
            margin-bottom: 30px;
        }

        #resume-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 5px 0 #1e8449;
            width: 100%;
        }

        #resume-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1e8449;
        }

        /* Store Screen */
        #store-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            overflow-y: auto;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            z-index: 200;
            pointer-events: auto;
        }

        #store-container {
            padding: 15px;
            margin: 0 auto;
        }

        #store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #store-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        #store-balance {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .store-coin-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            border: 2px solid #b8860b;
        }

        #store-balance span {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 1px 1px 0 #000;
        }

        .store-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .store-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .store-item:active {
            transform: scale(0.95);
        }

        .store-item.owned {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .store-item.selected {
            border: 3px solid #f39c12;
        }

        .item-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            border-radius: 10px;
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .item-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .store-item.owned .item-name {
            color: white;
        }

        .item-price {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            font-weight: 800;
            color: #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .item-price .mini-coin {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            border: 2px solid #b8860b;
        }

        .store-item.owned .item-price {
            color: white;
        }

        #close-store-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(231, 76, 60, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        #close-store-btn:active {
            transform: scale(0.9);
        }

        /* Power-up HUD */
        #powerups-hud {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        .powerup-icon {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.6);
            border: 3px solid #fff;
            border-radius: 15px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            backdrop-filter: blur(5px);
        }

        .powerup-icon.active {
            display: flex;
            animation: powerupPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes powerupPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .powerup-timer {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Poppins', sans-serif;
            font-size: 12px;
            font-weight: 800;
            color: white;
            text-shadow: 1px 1px 0 #000;
            white-space: nowrap;
        }

        /* Loading screen */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1a1a2e;
            z-index: 300;
        }

        #loading-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            animation: loadingPulse 1s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Notification */
        #character-notification {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            display: none;
            z-index: 250;
            animation: notificationPop 0.3s ease-out;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 80%;
        }

        @keyframes notificationPop {
            from { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Performance optimization */
        .performance-mode .store-item,
        .performance-mode .control-btn,
        .performance-mode .powerup-icon {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000;
        }

        /* Hide elements on very small screens */
        @media (max-height: 600px) {
            #controls-hint {
                display: none;
            }
            
            #mobile-controls {
                bottom: 15px;
            }
            
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
        }

        @media (max-width: 350px) {
            .store-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .item-preview {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-container">
        <!-- Loading Screen -->
        <div id="loading">
            <div id="loading-text">LOADING...</div>
        </div>
        
        <!-- Main Menu -->
        <div id="main-menu" class="hidden">
            <div id="game-logo">SUBWAY RUSH</div>
            <div id="subtitle">Endless Runner</div>
            <div id="high-score-display">HIGH SCORE: 0</div>
            <div id="total-coins-display" style="font-family: 'Poppins', sans-serif; font-size: 1.3rem; font-weight: 700; color: #ffd700; margin-bottom: 20px; text-shadow: 2px 2px 0 #000;">
                üí∞ Total Coins: <span id="total-coins">0</span>
            </div>
            <button id="play-btn" class="menu-button ui-element">TAP TO PLAY</button>
            <button id="store-btn" class="menu-button ui-element">STORE</button>
            <div id="controls-hint">
                <span>‚Üê</span> <span>‚Üí</span> Lane Change &nbsp;&nbsp; 
                <span>‚Üë</span> Jump &nbsp;&nbsp; 
                <span>‚Üì</span> Slide<br>
                Or swipe on screen!
            </div>
        </div>
        
        <!-- HUD -->
        <div id="hud" class="hidden">
            <button id="pause-btn" class="ui-element">‚ùö‚ùö</button>
            <div id="score-container">
                <div id="multiplier">x1</div>
                <div id="score">0</div>
                <div id="coins-display">
                    <div class="coin-icon"></div>
                    <div id="coins">0</div>
                </div>
            </div>
        </div>
        
        <!-- Power-ups HUD -->
        <div id="powerups-hud" class="hidden">
            <div id="magnet-icon" class="powerup-icon">
                üß≤
                <div class="powerup-timer" id="magnet-timer"></div>
            </div>
            <div id="jetpack-icon" class="powerup-icon">
                üöÄ
                <div class="powerup-timer" id="jetpack-timer"></div>
            </div>
        </div>
        
        <!-- Mobile Controls -->
        <div id="mobile-controls" class="hidden">
            <div class="control-column">
                <button id="left-btn" class="control-btn ui-element">‚Üê</button>
                <button id="right-btn" class="control-btn ui-element">‚Üí</button>
            </div>
            <div class="control-column">
                <button id="up-btn" class="control-btn ui-element">‚Üë</button>
                <button id="down-btn" class="control-btn ui-element">‚Üì</button>
            </div>
        </div>
        
        <!-- Swipe Area -->
        <div id="swipe-area" class="hidden"></div>
        
        <!-- Character Notification -->
        <div id="character-notification"></div>
        
        <!-- Pause Screen -->
        <div id="pause-screen">
            <div id="pause-panel">
                <div id="pause-title">PAUSED</div>
                <button id="resume-btn" class="ui-element">RESUME</button>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="game-over">
            <div id="game-over-panel">
                <div id="game-over-title">GAME OVER</div>
                <div id="new-record">üèÜ NEW HIGH SCORE!</div>
                <div class="stat-row">
                    <span class="stat-label">SCORE</span>
                    <span class="stat-value" id="final-score">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">COINS</span>
                    <span class="stat-value" id="final-coins">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">DISTANCE</span>
                    <span class="stat-value" id="final-distance">0m</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">BEST</span>
                    <span class="stat-value" id="best-score">0</span>
                </div>
                <div id="game-over-buttons">
                    <button id="retry-btn" class="game-over-btn ui-element">PLAY AGAIN</button>
                    <button id="menu-btn" class="game-over-btn ui-element">MENU</button>
                </div>
            </div>
        </div>
        
        <!-- Store Screen -->
        <div id="store-screen">
            <button id="close-store-btn" class="ui-element">‚úï</button>
            <div id="store-container">
                <div id="store-header">
                    <div id="store-title">STORE</div>
                    <div id="store-balance">
                        <div class="store-coin-icon"></div>
                        <span id="store-coins">0</span>
                    </div>
                </div>
                <div class="store-section">
                    <div class="section-title">CHARACTERS</div>
                    <div class="store-grid" id="characters-grid">
                        <!-- Characters will be added dynamically -->
                    </div>
                </div>
                <div class="store-section">
                    <div class="section-title">POWER-UPS</div>
                    <div class="store-grid" id="powerups-grid">
                        <!-- Power-ups will be added dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============================================
        // SUBWAY SURFERS MOBILE VERSION
        // ============================================
        
        // ===== MOBILE OPTIMIZATION CONFIG =====
        const MOBILE_CONFIG = {
            // Performance
            SHADOWS_ENABLED: false,
            ANTIALIAS: true,
            PIXEL_RATIO: Math.min(window.devicePixelRatio, 1.5),
            
            // Mobile controls
            SWIPE_THRESHOLD: 30,
            TAP_THRESHOLD: 200,
            VIBRATE_ON_COLLECT: true,
            
            // Graphics
            MAX_PARTICLES: 20,
            BUILDING_COUNT: 15,
            CLOUD_COUNT: 10,
            
            // Gameplay
            LANE_SWITCH_DURATION: 200,
            JUMP_DURATION: 700,
            SLIDE_DURATION: 600
        };
        
        // Merge with existing CONFIG
        Object.assign(CONFIG, {
            LANE_SWITCH_DURATION: MOBILE_CONFIG.LANE_SWITCH_DURATION,
            JUMP_DURATION: MOBILE_CONFIG.JUMP_DURATION,
            SLIDE_DURATION: MOBILE_CONFIG.SLIDE_DURATION
        });
        
        // ===== MOBILE INPUT MANAGER =====
        const MobileInput = {
            touchStartX: 0,
            touchStartY: 0,
            touchStartTime: 0,
            lastTapTime: 0,
            isTouching: false,
            
            init() {
                const swipeArea = document.getElementById('swipe-area');
                const leftBtn = document.getElementById('left-btn');
                const rightBtn = document.getElementById('right-btn');
                const upBtn = document.getElementById('up-btn');
                const downBtn = document.getElementById('down-btn');
                
                // Swipe area for gestures
                swipeArea.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
                swipeArea.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
                swipeArea.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
                
                // Button controls
                leftBtn.addEventListener('touchstart', () => this.handleButton('left'));
                rightBtn.addEventListener('touchstart', () => this.handleButton('right'));
                upBtn.addEventListener('touchstart', () => this.handleButton('up'));
                downBtn.addEventListener('touchstart', () => this.handleButton('down'));
                
                // Prevent context menu on long press
                document.addEventListener('contextmenu', e => e.preventDefault());
            },
            
            handleTouchStart(e) {
                e.preventDefault();
                this.touchStartX = e.touches[0].clientX;
                this.touchStartY = e.touches[0].clientY;
                this.touchStartTime = Date.now();
                this.isTouching = true;
            },
            
            handleTouchMove(e) {
                if (!this.isTouching) return;
                e.preventDefault();
            },
            
            handleTouchEnd(e) {
                if (!this.isTouching) return;
                e.preventDefault();
                
                const touch = e.changedTouches[0];
                const dx = touch.clientX - this.touchStartX;
                const dy = touch.clientY - this.touchStartY;
                const elapsed = Date.now() - this.touchStartTime;
                
                this.isTouching = false;
                
                // Check for tap (quick touch)
                if (elapsed < MOBILE_CONFIG.TAP_THRESHOLD && Math.abs(dx) < 20 && Math.abs(dy) < 20) {
                    this.handleTap();
                    return;
                }
                
                // Check for swipe
                if (elapsed > 300) return; // Too slow for swipe
                
                const absDx = Math.abs(dx);
                const absDy = Math.abs(dy);
                
                if (absDx > MOBILE_CONFIG.SWIPE_THRESHOLD || absDy > MOBILE_CONFIG.SWIPE_THRESHOLD) {
                    if (absDx > absDy) {
                        // Horizontal swipe
                        if (dx > 0) {
                            this.handleSwipe('right');
                        } else {
                            this.handleSwipe('left');
                        }
                    } else {
                        // Vertical swipe
                        if (dy > 0) {
                            this.handleSwipe('down');
                        } else {
                            this.handleSwipe('up');
                        }
                    }
                }
            },
            
            handleSwipe(direction) {
                if (gameState !== 'PLAYING') return;
                
                switch(direction) {
                    case 'left':
                        changeLane(-1);
                        break;
                    case 'right':
                        changeLane(1);
                        break;
                    case 'up':
                        jump();
                        break;
                    case 'down':
                        slide();
                        break;
                }
                
                // Haptic feedback (if supported)
                if (MOBILE_CONFIG.VIBRATE_ON_COLLECT && navigator.vibrate) {
                    navigator.vibrate(10);
                }
            },
            
            handleButton(action) {
                if (gameState !== 'PLAYING') return;
                
                switch(action) {
                    case 'left':
                        changeLane(-1);
                        break;
                    case 'right':
                        changeLane(1);
                        break;
                    case 'up':
                        jump();
                        break;
                    case 'down':
                        slide();
                        break;
                }
                
                // Haptic feedback
                if (MOBILE_CONFIG.VIBRATE_ON_COLLECT && navigator.vibrate) {
                    navigator.vibrate(10);
                }
            },
            
            handleTap() {
                // Double tap to pause
                const currentTime = Date.now();
                if (currentTime - this.lastTapTime < 300) {
                    togglePause();
                }
                this.lastTapTime = currentTime;
            }
        };
        
        // ===== MOBILE UI MANAGER =====
        const MobileUI = {
            init() {
                // Add performance mode class for mobile optimizations
                document.body.classList.add('performance-mode');
                
                // Handle orientation change
                window.addEventListener('orientationchange', this.handleOrientationChange.bind(this));
                window.addEventListener('resize', this.handleResize.bind(this));
                
                // Handle back button on Android
                if (window.history && window.history.pushState) {
                    window.history.pushState(null, null, window.location.href);
                    window.addEventListener('popstate', this.handleBackButton.bind(this));
                }
            },
            
            handleOrientationChange() {
                // Force resize after orientation change
                setTimeout(() => {
                    this.handleResize();
                }, 300);
            },
            
            handleResize() {
                // Update camera aspect ratio
                if (camera) {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                }
                
                // Update renderer size
                if (renderer) {
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }
                
                // Adjust UI elements for small screens
                if (window.innerHeight < 600) {
                    document.getElementById('powerups-hud').style.bottom = '100px';
                }
            },
            
            handleBackButton() {
                if (gameState === 'STORE') {
                    StoreManager.close();
                    window.history.pushState(null, null, window.location.href);
                } else if (gameState === 'PLAYING') {
                    togglePause();
                    window.history.pushState(null, null, window.location.href);
                }
            },
            
            showMobileControls(show) {
                const mobileControls = document.getElementById('mobile-controls');
                const swipeArea = document.getElementById('swipe-area');
                
                if (show) {
                    mobileControls.classList.remove('hidden');
                    swipeArea.classList.remove('hidden');
                } else {
                    mobileControls.classList.add('hidden');
                    swipeArea.classList.add('hidden');
                }
            },
            
            vibrate(pattern) {
                if (MOBILE_CONFIG.VIBRATE_ON_COLLECT && navigator.vibrate) {
                    navigator.vibrate(pattern);
                }
            }
        };
        
        // ===== MODIFIED INIT FUNCTION =====
        function init() {
            // Initialize mobile systems first
            MobileInput.init();
            MobileUI.init();
            
            // Initialize other systems
            SoundManager.init();
            CharacterManager.loadProgress();
            PowerUpManager.loadInventory();
            
            // Scene
            scene = new THREE.Scene();
            
            // Mobile-optimized sky
            scene.background = new THREE.Color(CONFIG.COLORS.SKY_TOP);
            scene.fog = new THREE.Fog(0xe8e8e8, 30, 100); // Reduced fog distance
            
            // Camera
            camera = new THREE.PerspectiveCamera(
                70, // Wider field of view for mobile
                window.innerWidth / window.innerHeight,
                0.1,
                150
            );
            camera.position.set(0, CONFIG.CAMERA_HEIGHT, -CONFIG.CAMERA_DISTANCE);
            camera.lookAt(0, 2, CONFIG.CAMERA_LOOK_AHEAD);
            
            // Mobile-optimized renderer
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('gameCanvas'),
                antialias: MOBILE_CONFIG.ANTIALIAS,
                alpha: false,
                powerPreference: "high-performance",
                precision: "mediump" // Better performance on mobile
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(MOBILE_CONFIG.PIXEL_RATIO);
            renderer.shadowMap.enabled = MOBILE_CONFIG.SHADOWS_ENABLED;
            renderer.outputEncoding = THREE.sRGBEncoding;
            
            // Simplified lighting for mobile
            setupMobileLighting();
            
            // Create environment
            createMobileSkybox();
            createGround();
            createPlayer();
            
            // Initial track segments (reduced count)
            for (let i = 0; i < 3; i++) {
                createTrackSegment(i * CONFIG.SEGMENT_LENGTH);
            }
            
            // Reduced building count
            createMobileBuildings();
            
            // Event listeners
            setupMobileEventListeners();
            
            // Store
            StoreManager.init();
            
            // Hide loading, show menu
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
            updateHighScoreDisplay();
            updateTotalCoins();
            
            gameState = 'MENU';
            
            // Start render loop
            requestAnimationFrame(gameLoop);
        }
        
        function setupMobileLighting() {
            // Simplified lighting for mobile performance
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            
            const sun = new THREE.DirectionalLight(0xfff5e6, 0.8);
            sun.position.set(-20, 30, 20);
            sun.castShadow = MOBILE_CONFIG.SHADOWS_ENABLED;
            if (MOBILE_CONFIG.SHADOWS_ENABLED) {
                sun.shadow.mapSize.width = 1024;
                sun.shadow.mapSize.height = 1024;
            }
            scene.add(sun);
            
            const fillLight = new THREE.DirectionalLight(0x87ceeb, 0.3);
            fillLight.position.set(10, 10, -20);
            scene.add(fillLight);
        }
        
        function createMobileSkybox() {
            // Simple sky for mobile
            const skyGeo = new THREE.BoxGeometry(100, 50, 100);
            const skyMat = new THREE.MeshBasicMaterial({
                color: CONFIG.COLORS.SKY_TOP,
                side: THREE.BackSide
            });
            const sky = new THREE.Mesh(skyGeo, skyMat);
            sky.position.y = 25;
            scene.add(sky);
            
            // Reduced cloud count
            createMobileClouds();
        }
        
        function createMobileClouds() {
            const cloudMat = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.7
            });
            
            for (let i = 0; i < MOBILE_CONFIG.CLOUD_COUNT; i++) {
                const cloud = new THREE.Group();
                const numPuffs = 3 + Math.floor(Math.random() * 4);
                
                for (let j = 0; j < numPuffs; j++) {
                    const puffGeo = new THREE.SphereGeometry(1 + Math.random() * 2, 8, 8);
                    const puff = new THREE.Mesh(puffGeo, cloudMat);
                    puff.position.set(
                        (Math.random() - 0.5) * 6,
                        (Math.random() - 0.5) * 1.5,
                        (Math.random() - 0.5) * 6
                    );
                    cloud.add(puff);
                }
                
                const angle = (i / MOBILE_CONFIG.CLOUD_COUNT) * Math.PI * 2;
                const radius = 40 + Math.random() * 20;
                cloud.position.set(
                    Math.cos(angle) * radius,
                    12 + Math.random() * 10,
                    Math.sin(angle) * radius + i * 15 - 150
                );
                
                cloud.userData = {
                    speed: 0.05 + Math.random() * 0.1,
                    initialZ: cloud.position.z
                };
                
                scene.add(cloud);
                clouds.push(cloud);
            }
        }
        
        function createMobileBuildings() {
            const buildingColors = [
                0xe74c3c, 0x3498db, 0x95a5a6, 0xd35400, 0x7f8c8d
            ];
            
            // Reduced building count for mobile
            for (let side of [-1, 1]) {
                for (let i = 0; i < MOBILE_CONFIG.BUILDING_COUNT; i++) {
                    const height = 8 + Math.random() * 20;
                    const width = 4 + Math.random() * 5;
                    const depth = 5 + Math.random() * 6;
                    
                    const buildingGeo = new THREE.BoxGeometry(width, height, depth);
                    const buildingColor = buildingColors[Math.floor(Math.random() * buildingColors.length)];
                    const buildingMat = new THREE.MeshLambertMaterial({
                        color: buildingColor
                    });
                    
                    const building = new THREE.Mesh(buildingGeo, buildingMat);
                    building.position.set(
                        side * (8 + Math.random() * 6),
                        height / 2,
                        i * 20 + Math.random() * 10
                    );
                    
                    scene.add(building);
                    buildings.push({
                        mesh: building,
                        initialZ: building.position.z
                    });
                }
            }
        }
        
        function setupMobileEventListeners() {
            // UI Buttons - touch events for mobile
            document.getElementById('play-btn').addEventListener('touchend', startGame);
            document.getElementById('store-btn').addEventListener('touchend', () => StoreManager.open());
            document.getElementById('close-store-btn').addEventListener('touchend', () => StoreManager.close());
            document.getElementById('pause-btn').addEventListener('touchend', togglePause);
            document.getElementById('resume-btn').addEventListener('touchend', togglePause);
            document.getElementById('retry-btn').addEventListener('touchend', startGame);
            document.getElementById('menu-btn').addEventListener('touchend', showMainMenu);
            
            // Store items - use touchend for better mobile response
            document.addEventListener('DOMContentLoaded', () => {
                // This will be handled dynamically in StoreManager.renderStore()
            });
            
            // Prevent zoom gestures during gameplay
            document.addEventListener('gesturestart', e => e.preventDefault());
            document.addEventListener('gesturechange', e => e.preventDefault());
            document.addEventListener('gestureend', e => e.preventDefault());
            
            // Handle app state changes
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && gameState === 'PLAYING') {
                    togglePause();
                }
            });
        }
        
        // ===== MODIFIED GAME FUNCTIONS =====
        function startGame() {
            // Show mobile controls
            MobileUI.showMobileControls(true);
            
            // Reset state (same as before)
            score = 0;
            coins = 0;
            distance = 0;
            currentSpeed = CONFIG.BASE_SPEED;
            multiplier = 1;
            currentLane = 1;
            targetLane = 1;
            isJumping = false;
            isSliding = false;
            isChangingLane = false;
            playerY = 0;
            lastObstacleZ = 0;
            lastCoinZ = 0;
            lastPowerUpZ = 0;
            lastKeyZ = 0;
            lastMysteryBoxZ = 0;
            
            // Reset NEW features
            collectedKeys = 0;
            scoreMultiplierKeys = 1;
            comboCount = 0;
            lastTrickTime = 0;
            
            // Clear obstacles, coins, and power-ups
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            coinObjects.forEach(c => scene.remove(c));
            coinObjects = [];
            PowerUpManager.powerUpObjects.forEach(p => scene.remove(p));
            PowerUpManager.powerUpObjects = [];
            PowerUpManager.clear();
            
            // Clear new collectibles
            keyObjects.forEach(k => scene.remove(k));
            keyObjects = [];
            mysteryBoxes.forEach(b => scene.remove(b));
            mysteryBoxes = [];
            
            // Deactivate hoverboard if active
            HoverboardManager.deactivate();
            
            // Remove cop
            if (copChaser) {
                scene.remove(copChaser);
                copChaser = null;
            }
            
            // Check for starting power-ups from inventory (simplified for mobile)
            if (PowerUpManager.inventory.magnetStart > 0 && Math.random() > 0.5) {
                PowerUpManager.useFromInventory('magnet');
                PowerUpManager.activate('magnet', 15);
                StoreManager.showNotification('Magnet Activated!');
            }
            
            if (PowerUpManager.inventory.jetpackStart > 0 && Math.random() > 0.5) {
                PowerUpManager.useFromInventory('jetpack');
                PowerUpManager.activate('jetpack', 12);
                StoreManager.showNotification('Jetpack Activated!');
            }
            
            // Reset player
            player.position.set(CONFIG.LANE_POSITIONS[1], 0, 0);
            player.rotation.set(0, 0, 0);
            player.scale.set(1, 1, 1);
            
            // UI
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('store-screen').style.display = 'none';
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('powerups-hud').classList.remove('hidden');
            
            // Brief tutorial for mobile
            const tutorial = document.getElementById('character-notification');
            tutorial.textContent = 'Swipe or use buttons to move!';
            tutorial.style.display = 'block';
            setTimeout(() => {
                tutorial.style.display = 'none';
            }, 2000);
            
            updateUI();
            updateTotalCoins();
            gameState = 'PLAYING';
            
            // Vibrate on start if supported
            MobileUI.vibrate(50);
        }
        
        function togglePause() {
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                document.getElementById('pause-screen').style.display = 'flex';
                MobileUI.vibrate(30);
            } else if (gameState === 'PAUSED') {
                gameState = 'PLAYING';
                document.getElementById('pause-screen').style.display = 'none';
                MobileUI.vibrate(30);
            }
        }
        
        function showMainMenu() {
            gameState = 'MENU';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('main-menu').classList.remove('hidden');
            MobileUI.showMobileControls(false);
            updateHighScoreDisplay();
        }
        
        function collectCoin(coin) {
            coin.userData.collected = true;
            coins++;
            totalCoins++;
            score += 10 * multiplier * scoreMultiplierKeys;
            
            // Vibrate on coin collect
            MobileUI.vibrate(20);
            
            SoundManager.play('coin');
            
            // Update missions
            MissionManager.updateProgress('coins', 1);
            
            // Collection animation
            const animateCoin = () => {
                coin.position.y += 0.3;
                coin.scale.multiplyScalar(0.9);
                if (coin.scale.x > 0.1) {
                    requestAnimationFrame(animateCoin);
                } else {
                    scene.remove(coin);
                    const idx = coinObjects.indexOf(coin);
                    if (idx > -1) coinObjects.splice(idx, 1);
                }
            };
            animateCoin();
            
            updateUI();
            updateTotalCoins();
        }
        
        function collectPowerUp(powerUp) {
            powerUp.userData.collected = true;
            const type = powerUp.userData.powerUpType;
            
            // Vibrate on power-up collect
            MobileUI.vibrate([50, 30, 50]);
            
            // Activate power-up
            if (type === 'magnet') {
                PowerUpManager.activate('magnet', 10);
                MissionManager.updateProgress('powerups', 1);
            } else if (type === 'jetpack') {
                PowerUpManager.activate('jetpack', 8);
                SoundManager.play('jetpackBoost');
                MissionManager.updateProgress('powerups', 1);
            } else if (type === 'sneakers') {
                activateSuperSneakers();
                StoreManager.showNotification('Super Sneakers! Higher jumps!');
                SoundManager.play('powerup');
                MissionManager.updateProgress('powerups', 1);
            }
            
            // Collection animation
            const animatePowerUp = () => {
                powerUp.position.y += 0.3;
                powerUp.scale.multiplyScalar(0.9);
                if (powerUp.scale.x > 0.1) {
                    requestAnimationFrame(animatePowerUp);
                } else {
                    scene.remove(powerUp);
                    const idx = PowerUpManager.powerUpObjects.indexOf(powerUp);
                    if (idx > -1) PowerUpManager.powerUpObjects.splice(idx, 1);
                }
            };
            animatePowerUp();
        }
        
        function gameOver() {
            gameState = 'GAME_OVER';
            
            // Vibrate on game over
            MobileUI.vibrate([100, 50, 100]);
            
            // Hide mobile controls
            MobileUI.showMobileControls(false);
            
            // COP APPEARS WHEN YOU CRASH!
            if (!copChaser) {
                createCopChaser();
                if (copChaser) {
                    copChaser.position.z = player.position.z - 3;
                }
            }
            
            // Check high score
            const isNewRecord = score > highScore;
            if (isNewRecord) {
                highScore = Math.floor(score);
                localStorage.setItem('subwaySurfersHighScore', highScore);
            }
            
            // Update game over screen
            document.getElementById('final-score').textContent = Math.floor(score).toLocaleString();
            document.getElementById('final-coins').textContent = coins;
            document.getElementById('final-distance').textContent = Math.floor(distance) + 'm';
            document.getElementById('best-score').textContent = highScore.toLocaleString();
            document.getElementById('new-record').style.display = isNewRecord ? 'block' : 'none';
            
            // Show game over
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('powerups-hud').classList.add('hidden');
            document.getElementById('game-over').style.display = 'flex';
        }
        
        // ===== MODIFIED GAME LOOP =====
        function gameLoop(currentTime) {
            deltaTime = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;
            
            if (gameState === 'PLAYING') {
                gameTime += deltaTime;
                distance += currentSpeed * deltaTime;
                score += currentSpeed * deltaTime * multiplier * scoreMultiplierKeys * 0.1;
                
                // Update mission progress for distance
                MissionManager.updateProgress('distance', currentSpeed * deltaTime);
                MissionManager.updateProgress('score', currentSpeed * deltaTime * multiplier * scoreMultiplierKeys * 0.1);
                
                updatePlayer(deltaTime);
                updateCopChaser(deltaTime);
                updateObstacles(deltaTime);
                updateCoins(deltaTime);
                updatePowerUpObjects(deltaTime);
                PowerUpManager.update();
                HoverboardManager.update();
                updateKeys(deltaTime);
                updateMysteryBoxes(deltaTime);
                updateTrack(deltaTime);
                updateSpeed(deltaTime);
                updateCamera();
                updateClouds(deltaTime);
                spawnObstacles();
                updateUI();
            }
            
            renderer.render(scene, camera);
            requestAnimationFrame(gameLoop);
        }
        
        // ===== START ON LOAD =====
        window.onload = init;
        
        // Prevent default touch behaviors
        document.addEventListener('touchmove', function(e) {
            if (gameState === 'PLAYING') {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Handle device orientation for better performance
        window.addEventListener('deviceorientation', function() {
            // Throttle orientation events for performance
        }, true);
        
        // Handle app suspend/resume
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && gameState === 'PLAYING') {
                togglePause();
            }
        });
    </script>
</body>
</html>
